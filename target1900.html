<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ターゲット1900 クイズ Battle</title>
<style>
:root{--bg:#0f172a;--primary:#1e40af;--accent:#3b82f6;--card:#ffffff;--ok:#10b981;--ng:#ef4444;--white:#ffffff;}
*{box-sizing:border-box;}
body{margin:0;font-family:"Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;background:linear-gradient(180deg,var(--bg),#0b1220);color:var(--white);padding:20px;display:flex;flex-direction:column;align-items:center;min-height:100vh;gap:12px;}
h1{margin:0 0 6px;font-size:24px;text-align:center}
.container{width:100%;max-width:980px}
.card{background:var(--card);color:#0f172a;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
.inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
input[type="text"],input[type="number"]{padding:8px 10px;border-radius:6px;border:1px solid #e5e7eb;font-size:14px;}
button{background:var(--accent);color:var(--white);border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;}
button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);color:inherit;}
#nameBox,#rangeSelection,#quizBox,#resultBox,#battleBox{display:none;}
#quizBox .status{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px;}
#question{font-size:20px;margin:10px 0 16px;}
#choices{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.choice-btn{padding:14px;font-size:16px;border-radius:10px;border:none;background:var(--primary);color:var(--white);cursor:pointer;transition:transform .12s ease,box-shadow .12s;}
.choice-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(30,64,175,0.18);}
.choice-btn:disabled{opacity:.6;cursor:default;transform:none;box-shadow:none;}
#overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:2000;font-weight:900;-webkit-text-stroke:5px white;text-align:center;transform:scale(.6);opacity:0;transition:all .25s;}
#overlay.ok{color:var(--ok);}
#overlay.ng{color:var(--ng);}
#overlay.show{pointer-events:auto;opacity:1;transform:scale(1);animation:pop .45s ease;}
@keyframes pop{0%{transform:scale(.6)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
#countdownBig{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1500;font-size:6rem;font-weight:900;color:var(--white);text-shadow:0 6px 20px rgba(2,6,23,0.6);display:none;}
#countdownBig.small{font-size:2rem;}
#ranking,#battleRanking{margin-top:10px;max-height:200px;overflow:auto;border-radius:8px;padding:8px;background:#f8fafc;}
footer{font-size:12px;color:rgba(255,255,255,.6);margin-top:12px;}
@media(max-width:700px){#choices{grid-template-columns:1fr;}#countdownBig{font-size:4rem;}}
</style>
</head>
<body>
<div class="container">
<h1>ターゲット1900 — 4択クイズ & Battle</h1>

<div id="nameBox" class="card">
<h3>1) 名前入力</h3>
<div class="inline">
<input id="playerNameInput" type="text" placeholder="名前">
<button id="btnSaveName">決定</button>
</div>
</div>

<div id="rangeSelection" class="card">
<h3>2) 範囲と問題数</h3>
<div class="inline">
<label>開始<input id="startNum" type="number" min="1" max="1900" value="1"></label>
<label>終了<input id="endNum" type="number" min="1" max="1900" value="100"></label>
<label>問題数<input id="numQuestions" type="number" min="1" max="1000" value="20"></label>
<button id="btnStart">ローカル開始</button>
<button id="btnBattle">対戦待機</button>
</div>
</div>

<div id="quizBox" class="card">
<div class="status">
<div id="remaining">残り: 0</div>
<div id="timer">経過: 0.0s</div>
<div id="countdownSmall"></div>
</div>
<p id="question">単語: ---</p>
<div id="choices"></div>
</div>

<div id="resultBox" class="card">
<h2>結果</h2>
<div id="resultDetails"></div>
<div style="margin-top:8px">
<button id="btnRetry">再挑戦</button>
<button id="btnBackToRange" class="ghost">範囲に戻る</button>
</div>
<div id="ranking" class="card"></div>
<div id="battleRanking" class="card"></div>
</div>

</div>
<div id="overlay"></div>
<div id="countdownBig"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, doc, updateDoc, onSnapshot, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyAHI9pAKyF_WQDkKq5eK00rtq9YaRCt4RY",
authDomain:"target1900-7fdbf.firebaseapp.com",
projectId:"target1900-7fdbf",
storageBucket:"target1900-7fdbf.firebasestorage.app",
messagingSenderId:"1012046894826",
appId:"1:1012046894826:web:08306a0eefd6f1cbf66993",
measurementId:"G-YJCFD36EPX"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let WORDS = [], playerName="", quizQueue=[], filteredWords=[], currentQuestion=null, elapsedTime=0, timerInterval=null;
let correctCount=0, questionsTotal=0, battleRoomId="", battleOpponent=null;

const nameBox=document.getElementById('nameBox');
const rangeSelection=document.getElementById('rangeSelection');
const quizBox=document.getElementById('quizBox');
const resultBox=document.getElementById('resultBox');
const overlay=document.getElementById('overlay');
const countdownBig=document.getElementById('countdownBig');
const playerNameInput=document.getElementById('playerNameInput');
const btnSaveName=document.getElementById('btnSaveName');
const btnStart=document.getElementById('btnStart');
const btnBattle=document.getElementById('btnBattle');
const btnRetry=document.getElementById('btnRetry');
const btnBackToRange=document.getElementById('btnBackToRange');
const startNumEl=document.getElementById('startNum');
const endNumEl=document.getElementById('endNum');
const numQuestionsEl=document.getElementById('numQuestions');
const remainingEl=document.getElementById('remaining');
const timerEl=document.getElementById('timer');
const choicesEl=document.getElementById('choices');
const questionEl=document.getElementById('question');
const rankingDiv=document.getElementById('ranking');
const battleRankingDiv=document.getElementById('battleRanking');

nameBox.style.display='block';
fetch('words.json').then(r=>r.json()).then(data=>{ WORDS=data; });

btnSaveName.addEventListener('click', ()=>{
  const v=playerNameInput.value.trim();
  if(!v){ alert('名前を入力'); return; }
  playerName=v; nameBox.style.display='none'; rangeSelection.style.display='block';
});

btnStart.addEventListener('click', startLocalQuiz);
btnRetry.addEventListener('click', ()=>{ resultBox.style.display='none'; rangeSelection.style.display='block'; });
btnBackToRange.addEventListener('click', ()=>{ resultBox.style.display='none'; rangeSelection.style.display='block'; });
btnBattle.addEventListener('click', startBattle);

function startLocalQuiz(){
  const start=parseInt(startNumEl.value), end=parseInt(endNumEl.value), numQ=parseInt(numQuestionsEl.value);
  if(isNaN(start)||isNaN(end)||isNaN(numQ)||start<1||end>WORDS.length||start>end||numQ<1){ alert('正しい範囲/問題数'); return; }
  const rangeArr = WORDS.slice(start-1,end);
  const take = Math.min(numQ, rangeArr.length);
  filteredWords = shuffleArray(rangeArr).slice(0, take);
  quizQueue = shuffleArray([...filteredWords]);
  questionsTotal = take; correctCount=0; elapsedTime=0;
  rangeSelection.style.display='none'; quizBox.style.display='block'; remainingEl.textContent=`残り: ${quizQueue.length}`;
  timerEl.textContent=`経過: 0.0s`; showBigCountdown(3, ()=>{ startTimer(); showQuestion(); });
}

function startBattle(){
  alert("Battleモード待機: 相手が入室するまで待ちます...");
  // Battle Room 作成
  addDoc(collection(db,'battles'),{host:playerName,createdAt:serverTimestamp(),players:{[playerName]:{score:0,current:0,finished:false}}}).then(docRef=>{
    battleRoomId=docRef.id;
    watchBattle(docRef.id);
    rangeSelection.style.display='none';
  });
}

function watchBattle(roomId){
  const roomDoc=doc(db,'battles',roomId);
  onSnapshot(roomDoc,(snap)=>{
    const data=snap.data();
    if(!data) return;
    battleOpponent=Object.keys(data.players).find(p=>p!==playerName);
    if(battleOpponent && !quizQueue.length){
      alert("対戦開始: "+battleOpponent+" と同時スタート");
      startLocalQuiz();
    }
  });
}

function showBigCountdown(seconds,onFinish){
  countdownBig.style.display='block'; countdownBig.classList.remove('small');
  let t=seconds; countdownBig.textContent=t;
  const id=setInterval(()=>{ t--; if(t>0) countdownBig.textContent=t; else{ clearInterval(id); countdownBig.classList.add('small'); countdownBig.textContent='スタート!'; setTimeout(()=>{ countdownBig.style.display='none'; onFinish(); },700); } },1000);
}

function startTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=setInterval(()=>{ elapsedTime+=0.1; timerEl.textContent=`経過: ${elapsedTime.toFixed(1)}s`; },100);}
function stopTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }}

function showQuestion(){
  if(quizQueue.length===0){ showResultUI(); return; }
  currentQuestion = quizQueue.shift();
  remainingEl.textContent=`残り: ${quizQueue.length+1}`;
  questionEl.textContent=`単語: ${currentQuestion.word}`;
  choicesEl.innerHTML='';
  const choices=[currentQuestion.meaning];
  while(choices.length<4){ const c=WORDS[Math.floor(Math.random()*WORDS.length)].meaning; if(!choices.includes(c)) choices.push(c); }
  shuffleArray(choices).forEach(text=>{
    const btn=document.createElement('button'); btn.className='choice-btn'; btn.textContent=text;
    btn.onclick=()=>{ stopTimer(); if(text===currentQuestion.meaning) correctCount++; overlay.textContent=(text===currentQuestion.meaning)?'○':'×'; overlay.className=(text===currentQuestion.meaning)?'ok show':'ng show'; document.querySelectorAll('.choice-btn').forEach(b=>b.disabled=true); setTimeout(()=>{ overlay.className=''; startTimer(); showQuestion(); },700); };
    choicesEl.appendChild(btn);
  });
}

async function showResultUI(){
  stopTimer();
  quizBox.style.display='none'; resultBox.style.display='block';
  const incorrect=questionsTotal-correctCount, penalty=incorrect*5, totalTime=elapsedTime+penalty, rate=((correctCount/questionsTotal)*100).toFixed(1);
  const det=document.getElementById('resultDetails');
  det.innerHTML=`<p>名前: ${playerName}</p><p>正答率: ${rate}% (${correctCount}/${questionsTotal})</p><p>経過時間: ${elapsedTime.toFixed(1)} 秒</p><p>ペナルティ: ${penalty} 秒 (不正解 ${incorrect}問 ×5秒)</p><p><strong>合計時間: ${totalTime.toFixed(1)} 秒</strong></p>`;
  
  try{ await addDoc(collection(db,'rankings'),{name:playerName,time:Number(totalTime.toFixed(1)),correctCount,totalQuestions:questionsTotal,createdAt:serverTimestamp()}); }catch(e){ console.warn(e); }
  await showRanking();
}

async function showRanking(){
  rankingDiv.style.display='block'; rankingDiv.innerHTML='<h3>ランキング（総合・上位10）</h3><div id="rankingList">取得中…</div>';
  try{
    const q=query(collection(db,'rankings'),orderBy('time','asc'),limit(10));
    const snap=await getDocs(q);
    const list=[...snap.docs].map((d,i)=>({id:d.id,...d.data()}));
    document.getElementById('rankingList').innerHTML=list.map((r,i)=>`<div>${i+1}. <strong>${r.name}</strong> — ${Number(r.time).toFixed(1)}s</div>`).join('')||'<div>記録なし</div>';
  }catch(e){ document.getElementById('rankingList').innerHTML='<div>取得失敗</div>'; console.warn(e); }
}

function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

</script>
</body>
</html>