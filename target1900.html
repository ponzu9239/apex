<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ターゲット1900 クイズ — ランキング & 対戦</title>
<style>
  :root{
    --bg:#0f172a;
    --primary:#1e40af;
    --accent:#3b82f6;
    --card:#ffffff;
    --ok:#10b981;
    --ng:#ef4444;
    --white:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background:linear-gradient(180deg,var(--bg), #0b1220);
    color:var(--white);
    padding:28px;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    gap:18px;
  }

  h1{margin:0 0 6px;font-size:28px; text-align:center}
  .container{width:100%;max-width:980px}

  /* card */
  .card{
    background:var(--card);
    color:#0f172a;
    border-radius:12px;
    padding:20px;
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
  }

  /* top controls */
  #nameBox, #rangeSelection, #quizBox, #resultBox, #battleBox { display:none; }
  .inline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  input[type="text"], input[type="number"]{
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #e5e7eb;
    font-size:16px;
  }

  button{
    background:var(--accent);
    color:var(--white);
    border:none;
    padding:10px 16px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
  button.ghost{
    background:transparent;
    border:1px solid rgba(0,0,0,0.08);
    color:inherit;
  }

  /* quiz area */
  #quizBox .status{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px;}
  #quizBox .status div{font-weight:700;color:#0f172a}
  #question{font-size:26px;margin:12px 0 20px}
  #choices{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .choice-btn{
    padding:18px;
    font-size:18px;
    border-radius:12px;
    border:none;
    background:var(--primary);
    color:var(--white);
    cursor:pointer;
    transition:transform .12s ease, box-shadow .12s;
  }
  .choice-btn:hover{transform:translateY(-3px); box-shadow:0 8px 20px rgba(30,64,175,0.18)}
  .choice-btn:disabled{opacity:.6; cursor:default; transform:none; box-shadow:none}

  /* overlay ○× */
  #overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    pointer-events:none; z-index:2000; transform:scale(.6); opacity:0; transition:all .25s;
    font-weight:900; -webkit-text-stroke:8px white; text-align:center;
  }
  #overlay.ok { color:var(--ok) }
  #overlay.ng { color:var(--ng) }
  #overlay.show{ pointer-events:auto; opacity:1; transform:scale(1); animation:pop .45s ease; }
  @keyframes pop{0%{transform:scale(.6)}50%{transform:scale(1.3)}100%{transform:scale(1)}}

  /* countdown center */
  #countdownBig{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:1500;
    font-size:8rem; font-weight:900; color:var(--white); text-shadow:0 6px 20px rgba(2,6,23,0.6);
    display:none;
  }
  #countdownBig.small{font-size:3rem}

  /* result */
  #resultDetails p{margin:8px 0; font-size:16px; color:#0f172a}
  #ranking, #battleRanking{margin-top:14px; max-height:240px; overflow:auto; border-radius:8px; padding:10px; background:#f8fafc}

  /* bottom help */
  footer{font-size:13px;color:rgba(255,255,255,.6); margin-top:18px}

  /* responsive */
  @media (max-width:700px){
    #choices{grid-template-columns:1fr}
    #countdownBig{font-size:6rem}
  }
</style>
</head>
<body>
<div class="container">

  <h1>ターゲット1900 — 4択クイズ（ランキング & 対戦）</h1>

  <div id="nameBox" class="card">
    <h3>1) プレイヤー名を入力してください</h3>
    <div class="inline">
      <input id="playerNameInput" type="text" placeholder="あなたの名前 (例: Taro)">
      <button id="btnSaveName">名前を決定</button>
    </div>
  </div>

  <div id="rangeSelection" class="card">
    <h3>2) 範囲と出題数を選択</h3>
    <div class="inline">
      <label>開始
        <input id="startNum" type="number" min="1" max="1900" placeholder="1" value="1">
      </label>
      <label>終了
        <input id="endNum" type="number" min="1" max="1900" placeholder="500" value="100">
      </label>
      <label>問題数
        <input id="numQuestions" type="number" min="1" max="1000" placeholder="20" value="20">
      </label>
      <button id="btnSingle" class="ghost">1人プレイ</button>
      <button id="btnCreateBattle" class="ghost">対戦ルームを作る</button>
      <input id="battleRoomId" type="text" placeholder="ルームIDを入力して参加">
      <button id="btnJoinBattle" class="ghost">参加する</button>
    </div>
  </div>

  <div id="quizBox" class="card" style="display:none">
    <div class="status">
      <div id="remaining">残り: 0</div>
      <div id="timer">経過: 0.0s</div>
      <div id="countdownSmall"></div>
    </div>

    <p id="question" class="question">単語: ---</p>
    <div id="choices"></div>
  </div>

  <div id="resultBox" class="card" style="display:none">
    <h2>結果</h2>
    <div id="resultDetails"></div>
    <div style="margin-top:12px">
      <button id="btnRetry">もう一度挑戦</button>
      <button id="btnBackToRange" class="ghost">範囲選択に戻る</button>
    </div>

    <div id="ranking" style="display:none" class="card"></div>
    <div id="battleRanking" style="display:none" class="card"></div>
  </div>

</div>

<div id="overlay" aria-hidden="true"></div>
<div id="countdownBig" aria-hidden="true"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy, limit, getDocs,
  doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY_HERE",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =======================
   データ & 状態
======================= */
let WORDS = [];
fetch('words.json').then(r=>r.json()).then(data=>{ WORDS = data; }).catch(e=>console.error(e));

let playerName="", filteredWords=[], quizQueue=[], currentQuestion=null, elapsedTime=0, timerInterval=null, correctCount=0, questionsTotal=0, battleRoomId = null;
let isBattleMode = false;
let battlePlayers = [];
let unsubscribeBattle = null;

const nameBox = document.getElementById('nameBox');
const rangeSelection = document.getElementById('rangeSelection');
const quizBox = document.getElementById('quizBox');
const resultBox = document.getElementById('resultBox');
const overlay = document.getElementById('overlay');
const countdownBig = document.getElementById('countdownBig');
const battleBox = document.getElementById('battleBox');

const playerNameInput = document.getElementById('playerNameInput');
const btnSaveName = document.getElementById('btnSaveName');
const btnSingle = document.getElementById('btnSingle');
const btnCreateBattle = document.getElementById('btnCreateBattle');
const btnJoinBattle = document.getElementById('btnJoinBattle');
const battleRoomIdInput = document.getElementById('battleRoomId');
const btnRetry = document.getElementById('btnRetry');
const btnBackToRange = document.getElementById('btnBackToRange');

const startNumEl = document.getElementById('startNum');
const endNumEl = document.getElementById('endNum');
const numQuestionsEl = document.getElementById('numQuestions');

const remainingEl = document.getElementById('remaining');
const timerEl = document.getElementById('timer');
const choicesEl = document.getElementById('choices');
const questionEl = document.getElementById('question');
const countdownSmall = document.getElementById('countdownSmall');

const rankingDiv = document.getElementById('ranking');
const battleRankingDiv = document.getElementById('battleRanking');

btnSaveName.addEventListener('click', ()=>{ 
  if(!playerNameInput.value.trim()){alert('名前を入力してください'); return;} 
  playerName=playerNameInput.value.trim(); 
  nameBox.style.display='none'; 
  rangeSelection.style.display='block'; 
});

btnSingle.addEventListener('click', ()=>{ 
  isBattleMode = false;
  onStartClick(); 
});

btnCreateBattle.addEventListener('click', async () => {
  isBattleMode = true;
  await createBattleRoom();
});

btnJoinBattle.addEventListener('click', async () => {
  isBattleMode = true;
  battleRoomId = battleRoomIdInput.value.trim();
  if (!battleRoomId) {
    alert('ルームIDを入力してください');
    return;
  }
  await joinBattleRoom(battleRoomId);
});

btnRetry.addEventListener('click', ()=>{ 
  if (isBattleMode) {
    endBattle();
  }
  resultBox.style.display='none'; 
  rangeSelection.style.display='block'; 
});
btnBackToRange.addEventListener('click', ()=>{ 
  if (isBattleMode) {
    endBattle();
  }
  resultBox.style.display='none'; 
  rangeSelection.style.display='block'; 
});

nameBox.style.display='block';

/* --- 開始処理 --- */
function onStartClick(){
  const start = parseInt(startNumEl.value); 
  const end = parseInt(endNumEl.value); 
  const numQ = parseInt(numQuestionsEl.value);
  if(isNaN(start)||isNaN(end)||isNaN(numQ)||start<1||end>WORDS.length||start>end||numQ<1){ 
    alert('正しい範囲/問題数を入力してください'); 
    return; 
  }
  const rangeArr = WORDS.slice(start-1,end); 
  const take = Math.min(numQ,rangeArr.length);
  filteredWords = shuffleArray(rangeArr).slice(0,take); 
  quizQueue = shuffleArray([...filteredWords]);
  questionsTotal=take; 
  correctCount=0; 
  elapsedTime=0;
  
  // UIの切り替え
  rangeSelection.style.display='none'; 
  quizBox.style.display='block'; 
  remainingEl.textContent=`残り: ${quizQueue.length}`; 
  timerEl.textContent=`経過: 0.0s`;
  
  if (!isBattleMode) {
    showBigCountdown(3, ()=>{ startTimer(); showQuestion(); });
  } else {
    // 対戦モードの場合は、全員が準備完了するまで待機
    // この部分はFirebaseのロジックに依存
  }
}

/* --- タイマー & カウントダウン --- */
function startTimer(){ 
  if(timerInterval) clearInterval(timerInterval); 
  timerInterval = setInterval(()=>{
    elapsedTime+=0.1; 
    timerEl.textContent=`経過: ${elapsedTime.toFixed(1)}s`;
  },100);
}
function stopTimer(){ 
  if(timerInterval){ 
    clearInterval(timerInterval); 
    timerInterval = null;
  } 
}
function showBigCountdown(seconds,onFinish){ 
  countdownBig.style.display='block'; 
  let t=seconds; 
  countdownBig.textContent=t; 
  countdownBig.classList.remove('small'); 
  
  const id = setInterval(()=>{
    t--; 
    if(t>0){
      countdownBig.textContent=t;
    } else {
      clearInterval(id); 
      countdownBig.style.fontSize='3rem'; 
      countdownBig.classList.add('small'); 
      countdownBig.textContent='スタート！'; 
      setTimeout(()=>{
        countdownBig.style.display='none'; 
        countdownBig.style.fontSize=''; 
        onFinish && onFinish(); 
      },700);
    }
  },1000);
}

/* --- 問題表示 --- */
function showQuestion(){
  if(quizQueue.length === 0){ 
    showResultUI(); 
    return;
  }
  choicesEl.innerHTML=''; 
  currentQuestion = quizQueue.shift();
  remainingEl.textContent=`残り: ${quizQueue.length}`;
  questionEl.textContent=`単語: ${currentQuestion.word}`;
  
  const choices = [currentQuestion.meaning]; 
  const pool = filteredWords.length >= 4 ? filteredWords : WORDS;
  
  while(choices.length < 4){ 
    const rnd = pool[Math.floor(Math.random()*pool.length)].meaning; 
    if(!choices.includes(rnd)) {
      choices.push(rnd);
    }
  }
  shuffleArray(choices);
  
  choices.forEach(text=>{
    const btn = document.createElement('button'); 
    btn.className='choice-btn'; 
    btn.textContent = text; 
    btn.onclick = () => onChoiceClick(btn,text); 
    choicesEl.appendChild(btn); 
  });
}

/* --- 回答 --- */
function onChoiceClick(button,text){ 
  stopTimer(); 
  const isCorrect = (text === currentQuestion.meaning);
  if (isCorrect) {
    correctCount++;
  }
  
  // ○× 表示
  overlay.textContent = isCorrect ? '○' : '×'; 
  overlay.className = isCorrect ? 'ok show' : 'ng show'; 
  
  // ボタンを無効化
  document.querySelectorAll('.choice-btn').forEach(b=>b.disabled=true); 
  
  setTimeout(()=>{ 
    overlay.className = ''; 
    startTimer(); 
    showQuestion(); 
  },700);
}

/* --- 結果表示 --- */
async function showResultUI(){ 
  stopTimer(); 
  quizBox.style.display='none'; 
  resultBox.style.display='block';
  
  const totalQuestions = questionsTotal; 
  const incorrectCount = totalQuestions - correctCount; 
  const penalty = incorrectCount * 5; 
  const totalTime = elapsedTime + penalty; 
  const correctRate = ((correctCount / totalQuestions) * 100).toFixed(1);
  
  const det = document.getElementById('resultDetails');
  det.innerHTML = `<p>名前: ${escapeHtml(playerName)}</p>
<p>正答率: ${correctRate}% (${correctCount}/${totalQuestions})</p>
<p>経過時間: ${elapsedTime.toFixed(1)} 秒</p>
<p>ペナルティ: ${penalty} 秒 (不正解 ${incorrectCount}問 ×5秒)</p>
<p><strong>合計時間: ${totalTime.toFixed(1)} 秒</strong></p>`;
  
  try { 
    if (!isBattleMode) {
      // シングルプレイの場合のみランキングに保存
      await addDoc(collection(db, 'rankings'), {
        name: playerName, 
        time: Number(totalTime.toFixed(1)), 
        correctCount, 
        totalQuestions, 
        createdAt: serverTimestamp()
      });
      await showRanking();
    } else {
      // 対戦モードの場合、結果をFirestoreに更新
      const playerRef = doc(db, 'battles', battleRoomId, 'players', localStorage.getItem('playerId'));
      await updateDoc(playerRef, {
        time: Number(totalTime.toFixed(1)),
        correctCount,
        incorrectCount
      });
      await showBattleRanking();
    }
  } catch(e) {
    console.warn("Firestore save failed:", e);
  }
}

async function showRanking(){ 
  rankingDiv.style.display='block'; 
  rankingDiv.innerHTML = '<h3>ランキング（総合・上位10）</h3><div id="rankingList">取得中…</div>'; 
  try{ 
    const q = query(collection(db,'rankings'), orderBy('time','asc'), limit(10)); 
    const snap = await getDocs(q); 
    const list = snap.docs.map(d=>({id:d.id,...d.data()})); 
    const html = list.map((r,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eef2ff">${i+1}. <strong>${escapeHtml(r.name)}</strong> — ${Number(r.time).toFixed(1)}s</div>`).join(''); 
    document.getElementById('rankingList').innerHTML = html || '<div>まだ記録がありません</div>'; 
  }catch(e){ 
    document.getElementById('rankingList').innerHTML = '<div>取得失敗</div>'; 
    console.warn(e);
  }
}

/* --- 対戦モード関連 --- */
async function createBattleRoom() {
  const start = parseInt(startNumEl.value); 
  const end = parseInt(endNumEl.value); 
  const numQ = parseInt(numQuestionsEl.value);
  if(isNaN(start)||isNaN(end)||isNaN(numQ)||start<1||end>WORDS.length||start>end||numQ<1){ 
    alert('正しい範囲/問題数を入力してください'); 
    return; 
  }
  const rangeArr = WORDS.slice(start-1,end); 
  const take = Math.min(numQ,rangeArr.length);
  const questions = shuffleArray(rangeArr).slice(0,take).map(q => ({word: q.word, meaning: q.meaning}));

  try {
    const docRef = await addDoc(collection(db, 'battles'), {
      status: 'waiting',
      questions: questions,
      createdAt: serverTimestamp(),
      playersReady: 0,
      totalPlayers: 1,
    });
    battleRoomId = docRef.id;
    const playerRef = await addDoc(collection(db, 'battles', battleRoomId, 'players'), {
      name: playerName,
      status: 'waiting',
      time: null,
      correctCount: null,
      incorrectCount: null,
    });
    localStorage.setItem('playerId', playerRef.id);
    alert(`ルームを作成しました！\nルームID: ${battleRoomId}\nこのIDを友達に教えてください`);
    startBattleListener();
  } catch (e) {
    console.error("Error creating battle room: ", e);
    alert('ルーム作成に失敗しました。');
  }
}

async function joinBattleRoom(id) {
  try {
    const battleRef = doc(db, 'battles', id);
    const battleSnap = await getDoc(battleRef);
    if (!battleSnap.exists()) {
      alert('存在しないルームIDです。');
      return;
    }
    const playerRef = await addDoc(collection(db, 'battles', id, 'players'), {
      name: playerName,
      status: 'waiting',
      time: null,
      correctCount: null,
      incorrectCount: null,
    });
    localStorage.setItem('playerId', playerRef.id);
    await updateDoc(battleRef, { totalPlayers: battleSnap.data().totalPlayers + 1 });
    battleRoomId = id;
    alert('ルームに参加しました！');
    startBattleListener();
  } catch (e) {
    console.error("Error joining battle room: ", e);
    alert('ルーム参加に失敗しました。');
  }
}

function startBattleListener() {
  const battleRef = doc(db, 'battles', battleRoomId);
  unsubscribeBattle = onSnapshot(battleRef, (docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      if (data.status === 'in-progress') {
        const questions = data.questions;
        filteredWords = questions;
        quizQueue = [...questions];
        questionsTotal = questions.length;
        correctCount = 0;
        elapsedTime = 0;
        rangeSelection.style.display = 'none';
        quizBox.style.display = 'block';
        showBigCountdown(3, () => {
          startTimer();
          showQuestion();
        });
      } else if (data.status === 'completed') {
        showBattleRanking();
      }
    }
  });

  // プレイヤーリストの監視
  onSnapshot(collection(db, 'battles', battleRoomId, 'players'), (snap) => {
    battlePlayers = snap.docs.map(d => ({id: d.id, ...d.data()}));
    // ロビー画面などでプレイヤーリストを表示するUIがあれば、ここで更新
  });
}

async function showBattleRanking() {
  stopTimer();
  const battleRef = doc(db, 'battles', battleRoomId);
  const playersSnap = await getDocs(collection(db, 'battles', battleRoomId, 'players'));
  const players = playersSnap.docs.map(d => ({...d.data(), id: d.id})).sort((a,b) => a.time - b.time);
  
  resultBox.style.display = 'block';
  rankingDiv.style.display = 'none';
  battleRankingDiv.style.display = 'block';
  battleRankingDiv.innerHTML = `<h3>対戦結果（ルームID: ${battleRoomId}）</h3><div id="battleRankingList"></div>`;
  const listEl = document.getElementById('battleRankingList');
  if (players.every(p => p.time !== null)) {
    const html = players.map((p, i) => {
      const isMe = p.id === localStorage.getItem('playerId');
      return `<div style="padding:6px 0;border-bottom:1px solid #eef2ff;${isMe ? 'font-weight:bold;' : ''}">
                ${i+1}. ${escapeHtml(p.name)} — ${p.time ? p.time.toFixed(1) + 's' : '未完了'}
              </div>`;
    }).join('');
    listEl.innerHTML = html;
  } else {
    listEl.innerHTML = '全員が完了するまでお待ちください...';
    // 全員完了したら status を 'completed' に更新
    const allDone = players.every(p => p.time !== null);
    if(allDone){
      await updateDoc(battleRef, {status: 'completed'});
    }
  }
}

function endBattle() {
  if (unsubscribeBattle) {
    unsubscribeBattle();
  }
  battleRoomId = null;
  isBattleMode = false;
  localStorage.removeItem('playerId');
  battleRankingDiv.style.display = 'none';
}

/* --- ユーティリティ関数 --- */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}
</script>
</body>
</html>
